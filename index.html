<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Doraemon AI</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  font-family: 'Nunito', sans-serif;
  background: linear-gradient(180deg, #87ceeb 0%, #b8dfe8 40%, #e8f4fd 100%);
  min-height: 100vh;
  display: flex;
  justify-content: center;
  overflow: hidden;
}

.cloud { position: fixed; background: white; border-radius: 50px; opacity: 0.6; animation: floatCloud linear infinite; z-index: 0; }
.cloud::before, .cloud::after { content: ''; position: absolute; background: white; border-radius: 50%; }
.c1 { width: 120px; height: 35px; top: 8%; animation-duration: 28s; left: -150px; }
.c1::before { width: 55px; height: 55px; top: -28px; left: 12px; }
.c1::after  { width: 38px; height: 38px; top: -18px; left: 48px; }
.c2 { width: 80px; height: 25px; top: 22%; animation-duration: 38s; animation-delay: -14s; left: -100px; }
.c2::before { width: 38px; height: 38px; top: -19px; left: 9px; }
.c2::after  { width: 26px; height: 26px; top: -13px; left: 32px; }
@keyframes floatCloud { from { left:-200px; } to { left:110%; } }

.app {
  display: flex; flex-direction: column;
  width: 100%; max-width: 480px; height: 100vh;
  position: relative; z-index: 1;
}

/* header */
.hdr { padding: 10px 16px 0; display: flex; flex-direction: column; align-items: center; flex-shrink: 0; }
.dface { width: 105px; height: 105px; animation: bob 3s ease-in-out infinite; filter: drop-shadow(0 6px 14px rgba(0,120,200,0.35)); }
@keyframes bob { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-6px)} }
.ttl { font-size: 1.55rem; font-weight: 900; color: #0077b6; margin: 3px 0 2px; }
.tag { font-size: 0.7rem; font-weight: 800; color: #0077b6; background: rgba(255,255,255,0.75); padding: 3px 12px; border-radius: 20px; margin-bottom: 7px; }

/* belt */
.belt { display: flex; gap: 6px; background: rgba(255,255,255,0.55); border-radius: 30px; padding: 6px 13px; margin-bottom: 6px; backdrop-filter: blur(8px); border: 2px solid rgba(255,255,255,0.8); }
.tb { width: 38px; height: 38px; border-radius: 50%; border: none; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.2s; position: relative; }
.tb:hover { transform: scale(1.18) rotate(-5deg); }
.tb::after { content: attr(data-tip); position: absolute; bottom: 110%; left: 50%; transform: translateX(-50%); background: #333; color: white; font-size: 0.58rem; font-family:'Nunito',sans-serif; font-weight: 700; white-space: nowrap; padding: 3px 7px; border-radius: 6px; opacity: 0; pointer-events: none; transition: opacity 0.2s; }
.tb:hover::after { opacity: 1; }
.t1{background:linear-gradient(135deg,#89cff0,#00a8e8)} .t2{background:linear-gradient(135deg,#ffd166,#f4a261)} .t3{background:linear-gradient(135deg,#a8e6cf,#3d9970)} .t4{background:linear-gradient(135deg,#c3a6ff,#7c4dff)} .t5{background:linear-gradient(135deg,#ff9a9e,#e63946)}

/* quick replies */
.qr { display: flex; gap: 5px; flex-wrap: wrap; padding: 3px 14px 5px; }
.qb { background: rgba(255,255,255,0.8); border: 2px solid #00a8e8; color: #0077b6; font-family:'Nunito',sans-serif; font-size: 0.68rem; font-weight: 800; padding: 4px 9px; border-radius: 18px; cursor: pointer; transition: all 0.2s; }
.qb:hover { background: #00a8e8; color: white; transform: translateY(-2px); }

/* chat */
.chat { flex: 1; overflow-y: auto; padding: 10px 13px; display: flex; flex-direction: column; gap: 8px; background: rgba(255,255,255,0.3); backdrop-filter: blur(8px); margin: 0 8px; border-radius: 16px 16px 0 0; border: 2px solid rgba(255,255,255,0.65); border-bottom: none; scrollbar-width: thin; scrollbar-color: #00a8e8 transparent; }
.chat::-webkit-scrollbar { width: 3px; }
.chat::-webkit-scrollbar-thumb { background: #00a8e8; border-radius: 2px; }

.msg { display: flex; gap: 7px; align-items: flex-end; animation: si 0.25s ease-out; }
@keyframes si { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }
.msg.user { flex-direction: row-reverse; }

.av { width: 29px; height: 29px; border-radius: 50%; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; background: #00a8e8; border: 2px solid white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
.msg.user .av { background: linear-gradient(135deg,#667eea,#764ba2); }

.bub { max-width: 78%; padding: 8px 12px; border-radius: 15px; font-size: 0.86rem; line-height: 1.45; font-weight: 600; box-shadow: 0 2px 7px rgba(0,0,0,0.07); }
.msg.bot  .bub { background: white; color: #1a1a2e; border-radius: 15px 15px 15px 3px; border: 1.5px solid rgba(0,168,232,0.16); }
.msg.user .bub { background: linear-gradient(135deg,#0077b6,#0096c7); color: white; border-radius: 15px 15px 3px 15px; }

.dots { display: flex; gap: 4px; padding: 3px 1px; align-items: center; }
.dot { width: 7px; height: 7px; background: #00a8e8; border-radius: 50%; animation: db 1.1s ease-in-out infinite; }
.dot:nth-child(2){animation-delay:.18s} .dot:nth-child(3){animation-delay:.36s}
@keyframes db { 0%,60%,100%{transform:translateY(0);opacity:.5} 30%{transform:translateY(-5px);opacity:1} }

.cur { color: #00a8e8; font-weight: 900; animation: cb 0.65s ease-in-out infinite; }
@keyframes cb { 0%,100%{opacity:1} 50%{opacity:0} }

/* input */
.irow { display: flex; gap: 7px; padding: 9px 13px; background: white; margin: 0 8px; border-radius: 0 0 16px 16px; border: 2px solid rgba(255,255,255,0.9); border-top: 1.5px solid rgba(0,168,232,0.15); box-shadow: 0 3px 14px rgba(0,0,0,0.07); flex-shrink: 0; }
#inp { flex: 1; border: 2px solid #e0e8ff; border-radius: 20px; padding: 8px 13px; font-family:'Nunito',sans-serif; font-size: 0.86rem; font-weight: 600; color: #1a1a2e; outline: none; background: #f8fcff; resize: none; max-height: 80px; transition: border-color 0.2s; }
#inp:focus { border-color: #00a8e8; background: white; }
#inp::placeholder { color: #9ab4c9; }
#sbtn { width: 40px; height: 40px; background: linear-gradient(135deg,#00a8e8,#0077b6); border: none; border-radius: 50%; color: white; font-size: 0.95rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; box-shadow: 0 3px 9px rgba(0,168,232,0.35); flex-shrink: 0; align-self: flex-end; }
#sbtn:hover { transform: scale(1.1); }
#sbtn:disabled { opacity: 0.45; cursor: not-allowed; transform: none; }

/* modal */
.modal { position: fixed; inset: 0; background: rgba(0,0,0,0.42); display: none; align-items: center; justify-content: center; z-index: 100; backdrop-filter: blur(4px); }
.modal.show { display: flex; }
.mbox { background: white; border-radius: 20px; padding: 20px; max-width: 290px; width: 88%; text-align: center; animation: pi 0.27s cubic-bezier(0.175,0.885,0.32,1.275); border: 3px solid #00a8e8; }
@keyframes pi { from{opacity:0;transform:scale(0.5)} to{opacity:1;transform:scale(1)} }
.mbox .me { font-size: 2.4rem; margin-bottom: 5px; }
.mbox h3 { color: #0077b6; font-size: 1rem; font-weight: 900; margin-bottom: 5px; }
.mbox p  { color: #555; font-size: 0.8rem; line-height: 1.5; font-weight: 600; margin-bottom: 12px; }
.mcl { background: #00a8e8; color: white; border: none; padding: 8px 20px; border-radius: 16px; font-family:'Nunito',sans-serif; font-weight: 800; cursor: pointer; }
.gap { height: 6px; flex-shrink: 0; }
</style>
</head>
<body>
<div class="cloud c1"></div>
<div class="cloud c2"></div>

<div class="app">
  <div class="hdr">
    <svg class="dface" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
      <circle cx="25"  cy="62"  r="20" fill="#00a8e8" stroke="#0077b6" stroke-width="2.5"/>
      <circle cx="175" cy="62"  r="20" fill="#00a8e8" stroke="#0077b6" stroke-width="2.5"/>
      <circle cx="100" cy="108" r="85" fill="#00a8e8" stroke="#0077b6" stroke-width="3"/>
      <ellipse cx="100" cy="118" rx="63" ry="59" fill="white"/>
      <circle cx="79"  cy="84"  r="18" fill="white" stroke="#222" stroke-width="1.8"/>
      <circle cx="121" cy="84"  r="18" fill="white" stroke="#222" stroke-width="1.8"/>
      <circle cx="84"  cy="84"  r="10" fill="#111"/>
      <circle cx="126" cy="84"  r="10" fill="#111"/>
      <circle cx="87"  cy="80"  r="3.5" fill="white"/>
      <circle cx="129" cy="80"  r="3.5" fill="white"/>
      <circle cx="100" cy="106" r="9" fill="#e63946" stroke="#c0392b" stroke-width="1.5"/>
      <path d="M 66 126 Q 100 152 134 126" fill="none" stroke="#222" stroke-width="2.5" stroke-linecap="round"/>
      <line x1="36" y1="114" x2="78" y2="120" stroke="#222" stroke-width="1.4" stroke-linecap="round"/>
      <line x1="36" y1="126" x2="78" y2="127" stroke="#222" stroke-width="1.4" stroke-linecap="round"/>
      <line x1="36" y1="138" x2="78" y2="134" stroke="#222" stroke-width="1.4" stroke-linecap="round"/>
      <line x1="122" y1="120" x2="164" y2="114" stroke="#222" stroke-width="1.4" stroke-linecap="round"/>
      <line x1="122" y1="127" x2="164" y2="126" stroke="#222" stroke-width="1.4" stroke-linecap="round"/>
      <line x1="122" y1="134" x2="164" y2="138" stroke="#222" stroke-width="1.4" stroke-linecap="round"/>
      <rect x="28" y="184" width="144" height="15" rx="7.5" fill="#e63946"/>
      <circle cx="100" cy="191" r="7" fill="#ffd166" stroke="#f4a261" stroke-width="2"/>
      <ellipse cx="100" cy="150" rx="26" ry="16" fill="rgba(255,255,255,0.22)" stroke="#0077b6" stroke-width="1.8"/>
    </svg>
    <div class="ttl">üîî Doraemon AI</div>
    <div class="tag">‚ú® Tera Magical Best Friend ‚ú®</div>
    <div class="belt">
      <button class="tb t1" data-tip="Anywhere Door" onclick="showTool('door')">üö™</button>
      <button class="tb t2" data-tip="Small Light"   onclick="showTool('light')">üî¶</button>
      <button class="tb t3" data-tip="Memory Bread"  onclick="showTool('mem')">üçû</button>
      <button class="tb t4" data-tip="Study Room"    onclick="showTool('study')">üìö</button>
      <button class="tb t5" data-tip="Mood Lifter"   onclick="showTool('fun')">üé≠</button>
    </div>
  </div>

  <div class="qr">
    <button class="qb" onclick="qs('bhai motivate kar')">üí™ Motivate</button>
    <button class="qb" onclick="qs('yaar sad hoon')">üòî Sad hoon</button>
    <button class="qb" onclick="qs('study mein help chahiye')">üìö Study</button>
    <button class="qb" onclick="qs('kuch funny bata')">üòÇ Fun</button>
  </div>

  <div class="chat" id="chat">
    <div class="msg bot">
      <div class="av">üîî</div>
      <div class="bub">aye bhai doraemon aa gaya! üîî<br>bol kya chal raha hai? üòÑ</div>
    </div>
  </div>

  <div class="irow">
    <textarea id="inp" rows="1" placeholder="kuch bhi bol... sun raha hoon üëÇ"
      onkeydown="onKey(event)" oninput="resize(this)"></textarea>
    <button id="sbtn" onclick="send()">‚û§</button>
  </div>
  <div class="gap"></div>
</div>

<div class="modal" id="modal" onclick="if(event.target===this)this.classList.remove('show')">
  <div class="mbox">
    <div class="me" id="mE"></div>
    <h3 id="mT"></h3>
    <p  id="mD"></p>
    <button class="mcl" onclick="document.getElementById('modal').classList.remove('show')">Theek hai bhai üëç</button>
  </div>
</div>

<script>
const TOOLS = {
  door:  {e:'üö™',t:'Anywhere Door', d:'Tujhe kisi bhi jagah le jaati hai! Apne sapno ki jagah imagine kar ‚Äî woh uni, woh city, woh life. Aaj se shuru!'},
  light: {e:'üî¶',t:'Small Light',   d:'Andheron mein roshni. Jab rasta nazar na aaye ‚Äî ek chhota goal set kar aaj ka. Ek step kafi hai.'},
  mem:   {e:'üçû',t:'Memory Bread',  d:'Jo padhna hai yaad ho jayega! Spaced repetition try kar ‚Äî baar baar padh, mind map bana.'},
  study: {e:'üìö',t:'Study Room',    d:'Phone door rakh, 25 min padh, 5 min break. Pomodoro technique ‚Äî actually kaam karti hai bhai!'},
  fun:   {e:'üé≠',t:'Mood Lifter',   d:'Tu Nobita hai jo ek din sabse amazing banta hai. Aur main tera Doraemon hoon ‚Äî hamesha saath!'}
};

function showTool(k) {
  const x = TOOLS[k];
  document.getElementById('mE').textContent = x.e;
  document.getElementById('mT').textContent = x.t;
  document.getElementById('mD').textContent = x.d;
  document.getElementById('modal').classList.add('show');
}

function getEmotion(t) {
  t = t.toLowerCase();
  if (/sad|dukhi|rona|cry|hurt|dard|depressed|akela|lonely|heartbreak|breakup|toot/.test(t)) return 'sad';
  if (/happy|khush|mast|great|amazing|accha|badhiya|excited|pass|success/.test(t))           return 'happy';
  if (/stress|pressure|thak|tired|bore|frustrated|anxiety/.test(t))                           return 'stress';
  if (/study|padh|exam|test|math|science|chapter|notes/.test(t))                              return 'study';
  if (/career|future|job|confused|kya karun|plan/.test(t))                                    return 'career';
  if (/motivat|himmat|hosla|king|winner/.test(t))                                             return 'motiv';
  if (/funny|joke|haha|lol|mazak|bakchodi/.test(t))                                           return 'fun';
  return 'general';
}

const history = [];

function addRow(html, who) {
  const c = document.getElementById('chat');
  const r = document.createElement('div');
  r.className = `msg ${who}`;
  r.innerHTML = `<div class="av">${who==='bot'?'üîî':'üë§'}</div><div class="bub">${html}</div>`;
  c.appendChild(r);
  c.scrollTop = 99999;
  return r.querySelector('.bub');
}

function showDots() {
  const c = document.getElementById('chat');
  const r = document.createElement('div');
  r.className = 'msg bot'; r.id = 'dotRow';
  r.innerHTML = '<div class="av">üîî</div><div class="bub"><div class="dots"><div class="dot"></div><div class="dot"></div><div class="dot"></div></div></div>';
  c.appendChild(r); c.scrollTop = 99999;
}
function hideDots() { const d=document.getElementById('dotRow'); if(d) d.remove(); }

async function send() {
  const el  = document.getElementById('inp');
  const txt = el.value.trim();
  if (!txt) return;

  el.value = ''; el.style.height = 'auto';
  document.getElementById('sbtn').disabled = true;

  addRow(txt.replace(/\n/g,'<br>'), 'user');
  history.push({ role:'user', content: txt });
  showDots();

  const sys = `Tu "Doraemon AI" hai ‚Äî ek magical best friend of students.

STRICT STYLE RULES:
- Bilkul WhatsApp / Instagram DM jaisa reply ‚Äî short, casual, real hinglish
- MAX 2 lines. No paragraphs. No lists. No bullet points.
- Max 2 emoji per reply
- Natural words: bhai, yaar, arre, chal, sun
- Har reply ALAG hona chahiye ‚Äî same wording mat repeat karna kabhi bhi
- QUESTION KE HISAAB SE REPLY KAR ‚Äî agar koi fact puche toh fact bata, agar emotional ho toh emotional support de, agar study/business puche toh smart answer de
- Emotion: ${getEmotion(txt)}
- Agar koi business, career, ya knowledge question puche ‚Äî toh SERIOUSLY aur SMARTLY jawab de, 2-3 lines mein sahi info de`;

  try {
    const res = await fetch('/api/chat', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        model:      'claude-haiku-4-5-20251001',
        max_tokens: 150,
        stream:     true,
        system:     sys,
        messages:   history
      })
    });

    if (!res.ok) {
      const err = await res.text();
      throw new Error(err);
    }

    const reader  = res.body.getReader();
    const decoder = new TextDecoder();
    let full = '';
    let bub  = null;
    let done = false;

    while (!done) {
      const { done: d, value } = await reader.read();
      done = d;
      if (!value) continue;

      const lines = decoder.decode(value, { stream: true }).split('\n');
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue;
        const raw = line.slice(6).trim();
        if (raw === '[DONE]') { done = true; break; }

        let ev;
        try { ev = JSON.parse(raw); } catch { continue; }

        if (ev.type === 'content_block_start' && ev.content_block?.type === 'text') {
          hideDots();
          bub = addRow('<span class="cur">|</span>', 'bot');
        }

        if (ev.type === 'content_block_delta' && ev.delta?.type === 'text_delta' && ev.delta.text) {
          full += ev.delta.text;
          if (bub) {
            bub.innerHTML = full.replace(/\n/g,'<br>') + '<span class="cur">|</span>';
            document.getElementById('chat').scrollTop = 99999;
          }
        }
      }
    }

    hideDots();
    if (bub) bub.innerHTML = full.replace(/\n/g,'<br>');
    else if (full) addRow(full.replace(/\n/g,'<br>'), 'bot');

    if (full) {
      history.push({ role:'assistant', content: full });
      if (history.length > 24) history.splice(0, 2);
    }

  } catch(e) {
    hideDots();
    console.error(e);
    addRow('bhai error aa gaya üòÖ dobara try kar!', 'bot');
  }

  document.getElementById('sbtn').disabled = false;
}

function qs(t) { document.getElementById('inp').value = t; send(); }
function onKey(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); } }
function resize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 80) + 'px'; }
</script>
</body>
</html>
